(()=>{"use strict";const e=window.wp.blocks,t=window.wp.i18n,n=window.wp.blockEditor,o=window.wp.components,c=window.wp.element,l=window.wp.compose,u="(https?):\\/\\/([\\w.-]*documentcloud\\.org)\\/documents\\/([0-9]+(?:-[\\w\\d%-]*)?)",d=[{type:"document",regex:new RegExp(`^${u}(\\.html)?$`)},{type:"page_hash",regex:new RegExp(`^${u}(\\.html)?\\/?\\??.*#document\\/p([0-9]+)$`),pageGroup:5},{type:"page_ext",regex:new RegExp(`^${u}\\/pages\\/([0-9]+)\\.(html|js)$`),pageGroup:4},{type:"page_no_ext",regex:new RegExp(`^${u}\\/pages\\/([0-9]+)\\/?\\??.*$`),pageGroup:4},{type:"note_annotations",regex:new RegExp(`^${u}\\/annotations\\/([0-9]+)\\.(html|js)$`),noteGroup:4},{type:"note_annotations_embed",regex:new RegExp(`^${u}\\/annotations\\/([0-9]+)\\/?\\??.*$`),noteGroup:4},{type:"note_hash_page",regex:new RegExp(`^${u}(\\.html)?\\/?\\??.*#document\\/p([0-9]+)\\/a([0-9]+)$`),pageGroup:5,noteGroup:6},{type:"note_hash_annotation",regex:new RegExp(`^${u}(\\.html)?\\/?\\??.*#annotation\\/a([0-9]+)(\\.[a-z]+)?$`),noteGroup:5}];function r(e){if(!e)return"document";const t=s(e);return t.note_id?"note":t.page_number?"page":e.includes("/annotations/")?"note":"document"}const s=e=>{if(!e)return{};const t=function(e){return e.includes("/pages/")?d.filter((e=>"page_ext"===e.type||"page_no_ext"===e.type)):e.includes("/annotations/")?d.filter((e=>"note_annotations"===e.type)):e.includes("#document/p")?e.includes("/a")?d.filter((e=>"note_hash_page"===e.type)):d.filter((e=>"page_hash"===e.type)):e.includes("#annotation/a")?d.filter((e=>"note_hash_annotation"===e.type)):d.filter((e=>"document"===e.type))}(e);for(const n of t){const t=e.match(n.regex);if(t){const e={protocol:t[1],dc_host:t[2],document_slug:t[3]};return n.pageGroup&&t[n.pageGroup]&&(e.page_number=t[n.pageGroup]),n.noteGroup&&t[n.noteGroup]&&(e.note_id=t[n.noteGroup]),e}}return{}},a=window.ReactJSXRuntime;function i({embeddedHtml:e,isLoading:l,fetchError:u,onChangeDocument:d}){const r=(0,c.useRef)(null),s=(0,n.useBlockProps)(),i=(0,c.useMemo)((()=>s.className?.includes("is-selected")),[s.className]);return null===l||l?(0,a.jsxs)("div",{className:"documentcloud-loading",children:[(0,a.jsx)(o.Spinner,{}),(0,a.jsx)("p",{children:(0,t.__)("Loading document…","documentcloud")})]}):u?(0,a.jsxs)("div",{className:"documentcloud-error-container",children:[(0,a.jsx)(o.Notice,{status:"error",isDismissible:!1,children:u}),(0,a.jsx)(m,{onChangeDocument:d})]}):e?(0,a.jsxs)("div",{className:"documentcloud-preview",ref:r,children:[(0,a.jsx)("div",{className:"documentcloud-embed documentcloud-oembed",dangerouslySetInnerHTML:{__html:e}}),i?null:(0,a.jsx)("div",{className:"documentcloud-overlay"}),(0,a.jsx)(m,{onChangeDocument:d})]}):(0,a.jsxs)("div",{className:"documentcloud-preview",ref:r,children:[(0,a.jsx)("div",{className:"documentcloud-placeholder",children:(0,a.jsx)("p",{children:(0,t.__)("Document preview not available.","documentcloud")})}),(0,a.jsx)(m,{onChangeDocument:d})]})}function m({onChangeDocument:e}){return(0,a.jsx)("div",{className:"documentcloud-preview-footer",children:(0,a.jsx)(o.Button,{variant:"secondary",onClick:e,className:"documentcloud-clear-button",children:(0,t.__)("Change Document","documentcloud")})})}const h=window.React;var p,g;function _(){return _=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_.apply(null,arguments)}var w=function(e){return h.createElement("svg",_({xmlns:"http://www.w3.org/2000/svg",width:24,height:24,fill:"none",viewBox:"0 0 50 50"},e),p||(p=h.createElement("g",{clipPath:"url(#DocumentCloud-Block-Icon_svg__a)"},h.createElement("path",{fill:"#87BBF1",d:"M46.926 29.481a10.2 10.2 0 0 0-2.16-2.13c-.147-.108-.33-.209-.524-.316-.413-.227-.928-.51-.96-.823-.052-.51-.073-.993-.093-1.46-.06-1.38-.117-2.684-.984-4.16-1.944-3.306-4.76-5.093-9.131-5.793a10.6 10.6 0 0 0-1.672-.127c-2.737 0-5.56.929-7.193 2.366q-.137.12-.25.224c-.263.24-.436.397-.558.397-.115 0-.318-.107-.62-.326a13.6 13.6 0 0 0-2.691-1.516c-1.347-.569-2.707-.857-4.042-.857-.742 0-1.472.091-2.171.272-.579.149-1.095.411-1.594.665-.446.227-.868.441-1.318.57a.7.7 0 0 1-.198.028c-.393 0-.849-.278-1.289-.548-.26-.158-.505-.308-.748-.41-1.093-.454-2.354-.694-3.647-.694-.716 0-1.413.074-2.074.22-.047.01-.135.026-.249.045-.223.04-.538.095-.872.167q-.494 1.18-.864 2.42l.18-.036c1.217-.24 2.513-.291 3.387-.291q.281 0 .475.005a7.4 7.4 0 0 1 2.476.467c.928.35 1.804.905 2.605 1.65.253.235.498.35.75.35.432 0 .713-.325.985-.64.107-.123.217-.25.332-.353 1.174-1.044 2.704-1.263 3.781-1.263q.364 0 .739.032c1.671.144 3.344.856 4.836 2.059l.044.035c.583.47 1.244 1.003 1.642 1.6.068.103.275.415.619.415.49 0 .702-.597.857-1.032.03-.088.06-.17.08-.214.975-2.085 3.429-3.33 6.564-3.33 1.139 0 2.269.17 3.268.492 2.936.943 6.109 3.187 6.209 6.653.023.82-.092 1.713-.354 2.73-.209.809.758 1.14 1.336 1.339.177.06.359.123.45.175 1.58.903 2.89 2.242 3.5 3.581.143.313.716 1.955.913 4.284l.043.508a24.4 24.4 0 0 0 1.823-3.936c-.39-1.357-1.175-2.87-1.638-3.494"}))),g||(g=h.createElement("defs",null,h.createElement("clipPath",{id:"DocumentCloud-Block-Icon_svg__a"},h.createElement("path",{fill:"#fff",d:"M0 0h50v50H0z"})))))};const f=JSON.parse('{"UU":"documentcloud/documentcloud"}');(0,e.registerBlockType)(f.UU,{icon:(0,a.jsx)(w,{}),edit:function({attributes:e,setAttributes:u}){const{url:d,documentId:s,useDocumentId:m,height:h,width:p,title:g,fullscreen:_,onlyshoworg:f,pdf:x,embeddedHtml:b}=e,[j,v]=(0,c.useState)(""),[y,S]=(0,c.useState)(""),[C,D]=(0,c.useState)(d||""),[R,E]=(0,c.useState)(s||""),[N,k]=(0,c.useState)({width:p||"",height:h||""}),[P,$]=(0,c.useState)(null),[I,B]=(0,c.useState)(d?r(d):"document"),[H,T]=(0,c.useState)(!(s||d)),U=(0,c.useRef)(!0),L=(0,c.useRef)(null),G=(0,c.useMemo)((()=>""===j),[j]),M="document"===I,O=(0,c.useCallback)(((e,t)=>{k((n=>({...n,[e]:t}))),u({[e]:t})}),[u]),z=(0,c.useCallback)((e=>{D(e),v("")}),[]),F=(0,c.useCallback)((e=>{/[^0-9]/.test(String(String(e).trim()))?v((0,t.__)("Document ID can only contain digits.","documentcloud")):(E(e),v(""))}),[]),q=(0,c.useCallback)((()=>{u({useDocumentId:!m}),v("")}),[m,u]),A=(0,c.useCallback)((e=>{e.preventDefault(),$(null);try{if(m){const e=R.trim(),n=e?{valid:!0,message:""}:{valid:!1,message:(0,t.__)("Please enter a DocumentCloud ID.","documentcloud")};v(n.message),n.valid&&(u({documentId:e,url:"",embeddedHtml:""}),B("document"),T(!1))}else{let e=C.trim();const n=(e=>{if(!e)return{valid:!1,message:(0,t.__)("Please enter a DocumentCloud URL.","documentcloud")};const n=e.trim(),o=new Set(["documentcloud.org","www.documentcloud.org","beta.documentcloud.org","embed.documentcloud.org","assets.documentcloud.org"]);try{const e=new URL(n);return"https:"!==e.protocol?{valid:!1,message:(0,t.__)("URL must use HTTPS protocol.","documentcloud")}:o.has(e.hostname)?{valid:!0,message:""}:{valid:!1,message:(0,t.__)("URL must be from a valid DocumentCloud domain.","documentcloud")}}catch(e){return{valid:!1,message:(0,t.__)("Please enter a valid URL.","documentcloud")}}})(e);if(v(n.message),n.valid){const t=r(e);if(B(t),"document"===t){const t=((e,t,n)=>{if(!e)return;const o=new URL(e);if(o)try{const e=o.searchParams,c=e.get("height");e.delete("height"),c&&t("height",c);const l=e.get("width");e.delete("width"),l&&t("width",l);const u=String(e.get("title"));e.delete("title"),["0","1"].includes(u)&&n({title:"1"===u});const d=String(e.get("onlyshoworg"));e.delete("onlyshoworg"),["0","1"].includes(d)&&n({onlyshoworg:"1"===d});const r=String(e.get("fullscreen"));e.delete("fullscreen"),["0","1"].includes(r)&&n({fullscreen:"1"===r});const s=String(e.get("pdf"));e.delete("pdf"),["0","1"].includes(s)&&n({pdf:"1"===s})}catch{}return o})(e,O,u);t&&(e=t.toString())}u({url:e,documentId:"",embeddedHtml:""}),T(!1)}}}catch(e){v((0,t.__)("An unexpected error occurred. Please try again.","documentcloud"))}}),[m,R,C,u,O]),J=(0,c.useCallback)((()=>{T(!0),v("")}),[]),W=(0,c.useCallback)((()=>{const e=0===String(N.width).length&&0===String(N.height).length;return(({useDocumentId:e,documentId:t,url:n,title:o,fullscreen:c,onlyshoworg:l,pdf:u,style:d,responsive:s=!0})=>{if(!(e?t:n))return"";let a="";e&&t?a=`https://www.documentcloud.org/documents/${encodeURIComponent(t.trim())}`:!e&&n&&(a=n.trim(),a.startsWith("https://")||(a=a.replace(/^http:\/\//,"https://")));const i=r(a);if(("page"===i||"note"===i)&&(a.includes("#document/p")||a.includes("#annotation/a"))){if(!a.includes("embed=1"))if(a.includes("?"))a=a.replace("?","?embed=1&");else{const e=a.indexOf("#");-1!==e?a=a.substring(0,e)+"?embed=1"+a.substring(e):a+="?embed=1"}return a}"boolean"!=typeof o&&(o=!0),"boolean"!=typeof c&&(c=!0);const m={embed:1,title:o?1:0,fullscreen:c?1:0,onlyshoworg:l?1:0,pdf:u?1:0,style:d||"",responsive:s?1:0},h=Object.entries(m).filter((([,e])=>""!==e)).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join("&");return h?`${a}?${h}`:a})({useDocumentId:m,documentId:s,url:d,title:g,fullscreen:_,onlyshoworg:f,pdf:x,width:N.width,height:N.height,responsive:e})}),[m,s,d,g,_,f,x,N]),V=(0,c.useCallback)((()=>((e,t,n)=>{if(!e)return"";const o=new URLSearchParams;if(o.append("url",e),o.append("format","json"),o.append("dnt","1"),t){const e=t.toString().replace(/[^0-9]/g,"");e&&o.append("maxwidth",e)}if(n){const e=n.toString().replace(/[^0-9]/g,"");e&&o.append("maxheight",e)}return`https://api.www.documentcloud.org/api/oembed/?${o.toString()}`})(W(),p,h)),[W,p,h]);(0,c.useEffect)((()=>(U.current=!0,()=>{U.current=!1})),[]),(0,c.useEffect)((()=>{H&&(D(d||""),E(s||""))}),[H,d,s]),(0,c.useEffect)((()=>{d&&U.current&&B(r(d))}),[d]),(0,c.useEffect)((()=>{U.current&&k({width:p||"",height:h||""})}),[p,h]),(0,c.useEffect)((()=>(L.current=(0,l.debounce)((async e=>{if(!e||H||!G||!U.current)return;$(!0),S("");const{html:t,error:n}=await(async e=>{try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return{html:(await t.json()).html||"",error:""}}catch(e){return{html:"",error:"Failed to load document preview."}}})(e);U.current&&(n&&S(n),u({embeddedHtml:t}),$(!1))}),700),()=>{L.current&&L.current.cancel()})),[H,G,u]),(0,c.useEffect)((()=>{const e=V();e&&!H&&G&&L.current&&L.current(e)}),[V,H,G]);const X=(0,n.useBlockProps)();return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.InspectorControls,{children:[(0,a.jsxs)(o.PanelBody,{title:(0,t.__)("Document Settings","documentcloud"),initialOpen:!0,children:[(0,a.jsx)(o.PanelRow,{children:(0,a.jsx)(o.TextControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,type:"number",label:(0,t.__)("Height","documentcloud"),value:N.height,onChange:e=>O("height",e),help:(0,t.__)("Set the height (Only numeric values allowed).","documentcloud")})}),(0,a.jsx)(o.PanelRow,{children:(0,a.jsx)(o.TextControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,type:"number",label:(0,t.__)("Width","documentcloud"),value:N.width,onChange:e=>O("width",e),help:(0,t.__)("Set the width (Only Numberic Values are allowed).","documentcloud")})})]}),M&&(0,a.jsxs)(o.PanelBody,{title:(0,t.__)("Display Options","documentcloud"),initialOpen:!0,children:[(0,a.jsx)(o.PanelRow,{children:(0,a.jsx)(o.ToggleControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,label:(0,t.__)("Show Title","documentcloud"),checked:g,onChange:()=>u({title:!g}),help:(0,t.__)("Show document title and contributor name.","documentcloud")})}),(0,a.jsx)(o.PanelRow,{children:(0,a.jsx)(o.ToggleControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,label:(0,t.__)("Show Fullscreen Button","documentcloud"),checked:_,onChange:()=>u({fullscreen:!_}),help:(0,t.__)("Show fullscreen control.","documentcloud")})}),(0,a.jsx)(o.PanelRow,{children:(0,a.jsx)(o.ToggleControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,label:(0,t.__)("Only Show Organization","documentcloud"),checked:f,onChange:()=>u({onlyshoworg:!f}),help:(0,t.__)("Show affiliation without username.","documentcloud")})}),(0,a.jsx)(o.PanelRow,{children:(0,a.jsx)(o.ToggleControl,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,label:(0,t.__)("Show PDF Download Link","documentcloud"),checked:x,onChange:()=>u({pdf:!x}),help:(0,t.__)("Shows PDF download link.","documentcloud")})})]})]}),(0,a.jsx)("div",{...X,children:!H&&G?(0,a.jsx)(i,{embeddedHtml:b,isLoading:P,fetchError:y,urlType:I,width:p,height:h,onChangeDocument:J}):(0,a.jsxs)(o.Placeholder,{icon:(0,a.jsx)(w,{}),label:(0,t.__)("DocumentCloud","documentcloud"),instructions:m?(0,t.__)("Enter a DocumentCloud ID to embed a document.","documentcloud"):(0,t.__)("Enter a DocumentCloud URL to embed a document, page or note.","documentcloud"),children:[!G&&j&&(0,a.jsx)(o.Notice,{status:"error",isDismissible:!1,children:j}),(0,a.jsx)("form",{onSubmit:A,className:"documentcloud-form",children:(0,a.jsxs)("div",{className:"documentcloud-input-wrapper",children:[(0,a.jsx)(o.ToggleControl,{label:(0,t.__)("Use Document ID","documentcloud"),checked:m,onChange:q,help:(0,t.__)("Toggle between URL and Document ID input.","documentcloud")}),(0,a.jsxs)("div",{className:"documentcloud-input-row",children:[m?(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(o.TextControl,{value:R,inputMode:"numeric",pattern:"[0-9]*",onChange:F,type:"text",placeholder:(0,t.__)("123456789","documentcloud"),className:!G&&R?"has-error":""})}):(0,a.jsx)(o.TextControl,{value:C,onChange:z,placeholder:(0,t.__)("https://www.documentcloud.org/documents/…","documentcloud"),className:!G&&C?"has-error":""}),(0,a.jsx)(o.Button,{variant:"primary",type:"submit",children:(0,t.__)("Embed","documentcloud")})]})]})})]})})]})},save:function({attributes:e}){const{embeddedHtml:t}=e,o=n.useBlockProps.save();return t?(0,a.jsx)("div",{...o,children:(0,a.jsx)("div",{className:"documentcloud-embed",dangerouslySetInnerHTML:{__html:t}})}):(0,a.jsx)("div",{...o})}})})();